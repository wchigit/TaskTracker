name: Deploy TaskTracker to Azure Container Apps

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        platforms: linux/amd64
        tags: tasktracker-backend:${{ github.sha }}
        outputs: type=docker,dest=/tmp/backend-image.tar
    
    - name: Build frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        platforms: linux/amd64
        tags: tasktracker-frontend:${{ github.sha }}
        outputs: type=docker,dest=/tmp/frontend-image.tar
    
    - name: Upload backend artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-image
        path: /tmp/backend-image.tar
        retention-days: 1
    
    - name: Upload frontend artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-image
        path: /tmp/frontend-image.tar
        retention-days: 1

  deploy-dev:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: dev
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download backend artifact
      uses: actions/download-artifact@v4
      with:
        name: backend-image
        path: /tmp
    
    - name: Download frontend artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-image
        path: /tmp
    
    - name: Load Docker images
      run: |
        docker load --input /tmp/backend-image.tar
        docker load --input /tmp/frontend-image.tar
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
    
    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ vars.ACR_NAME }}
    
    - name: Tag and push images to ACR
      run: |
        docker tag tasktracker-backend:${{ github.sha }} ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-backend:${{ github.sha }}
        docker tag tasktracker-frontend:${{ github.sha }} ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-frontend:${{ github.sha }}
        docker push ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-backend:${{ github.sha }}
        docker push ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-frontend:${{ github.sha }}
    
    - name: Deploy to Container Apps
      run: |
        az containerapp update \
          --name ${{ vars.BACKEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-backend:${{ github.sha }}
        
        az containerapp update \
          --name ${{ vars.FRONTEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-frontend:${{ github.sha }}

  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download backend artifact
      uses: actions/download-artifact@v4
      with:
        name: backend-image
        path: /tmp
    
    - name: Download frontend artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-image
        path: /tmp
    
    - name: Load Docker images
      run: |
        docker load --input /tmp/backend-image.tar
        docker load --input /tmp/frontend-image.tar
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
    
    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ vars.ACR_NAME }}
    
    - name: Tag and push images to ACR
      run: |
        docker tag tasktracker-backend:${{ github.sha }} ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-backend:${{ github.sha }}
        docker tag tasktracker-frontend:${{ github.sha }} ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-frontend:${{ github.sha }}
        docker push ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-backend:${{ github.sha }}
        docker push ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-frontend:${{ github.sha }}
    
    - name: Deploy to Container Apps
      run: |
        az containerapp update \
          --name ${{ vars.BACKEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-backend:${{ github.sha }}
        
        az containerapp update \
          --name ${{ vars.FRONTEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-frontend:${{ github.sha }}

  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download backend artifact
      uses: actions/download-artifact@v4
      with:
        name: backend-image
        path: /tmp
    
    - name: Download frontend artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-image
        path: /tmp
    
    - name: Load Docker images
      run: |
        docker load --input /tmp/backend-image.tar
        docker load --input /tmp/frontend-image.tar
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
    
    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ vars.ACR_NAME }}
    
    - name: Tag and push images to ACR
      run: |
        docker tag tasktracker-backend:${{ github.sha }} ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-backend:${{ github.sha }}
        docker tag tasktracker-frontend:${{ github.sha }} ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-frontend:${{ github.sha }}
        docker push ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-backend:${{ github.sha }}
        docker push ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-frontend:${{ github.sha }}
    
    - name: Deploy to Container Apps
      run: |
        az containerapp update \
          --name ${{ vars.BACKEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-backend:${{ github.sha }}
        
        az containerapp update \
          --name ${{ vars.FRONTEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/tasktracker-frontend:${{ github.sha }}