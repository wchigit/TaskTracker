name: Deploy TaskTracker to Azure Container Apps

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - production

permissions:
  contents: read
  id-token: write

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    outputs:
      backend-image-tag: ${{ steps.image-tags.outputs.backend-tag }}
      frontend-image-tag: ${{ steps.image-tags.outputs.frontend-tag }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Generate image tags
      id: image-tags
      run: |
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        BACKEND_TAG="backend:${GITHUB_SHA::8}-${TIMESTAMP}"
        FRONTEND_TAG="frontend:${GITHUB_SHA::8}-${TIMESTAMP}"
        echo "backend-tag=${BACKEND_TAG}" >> $GITHUB_OUTPUT
        echo "frontend-tag=${FRONTEND_TAG}" >> $GITHUB_OUTPUT
        echo "Generated tags: ${BACKEND_TAG}, ${FRONTEND_TAG}"
    
    - name: Build backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        tags: ${{ steps.image-tags.outputs.backend-tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        outputs: type=docker,dest=/tmp/backend.tar
    
    - name: Build frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        tags: ${{ steps.image-tags.outputs.frontend-tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        outputs: type=docker,dest=/tmp/frontend.tar
    
    - name: Upload backend image artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-image
        path: /tmp/backend.tar
        retention-days: 1
    
    - name: Upload frontend image artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-image
        path: /tmp/frontend.tar
        retention-days: 1

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment: dev
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ vars.AZURE_CLIENT_ID }}
        tenant-id: ${{ vars.AZURE_TENANT_ID }}
        subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
    
    - name: Download backend image
      uses: actions/download-artifact@v4
      with:
        name: backend-image
        path: /tmp
    
    - name: Download frontend image
      uses: actions/download-artifact@v4
      with:
        name: frontend-image
        path: /tmp
    
    - name: Load and push images to ACR
      run: |
        # Load Docker images
        docker load --input /tmp/backend.tar
        docker load --input /tmp/frontend.tar
        
        # Login to ACR
        az acr login --name ${{ vars.ACR_NAME }}
        
        # Tag and push images
        docker tag ${{ needs.build.outputs.backend-image-tag }} ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.backend-image-tag }}
        docker tag ${{ needs.build.outputs.frontend-image-tag }} ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.frontend-image-tag }}
        
        docker push ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.backend-image-tag }}
        docker push ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.frontend-image-tag }}
    
    - name: Deploy to Container Apps
      run: |
        # Deploy backend (environment variables are pre-configured in Container App)
        az containerapp update \
          --name ${{ vars.BACKEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.backend-image-tag }}
        
        # Deploy frontend (environment variables are pre-configured in Container App)
        az containerapp update \
          --name ${{ vars.FRONTEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.frontend-image-tag }}

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ vars.AZURE_CLIENT_ID }}
        tenant-id: ${{ vars.AZURE_TENANT_ID }}
        subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
    
    - name: Download backend image
      uses: actions/download-artifact@v4
      with:
        name: backend-image
        path: /tmp
    
    - name: Download frontend image
      uses: actions/download-artifact@v4
      with:
        name: frontend-image
        path: /tmp
    
    - name: Load and push images to ACR
      run: |
        # Load Docker images
        docker load --input /tmp/backend.tar
        docker load --input /tmp/frontend.tar
        
        # Login to ACR
        az acr login --name ${{ vars.ACR_NAME }}
        
        # Tag and push images
        docker tag ${{ needs.build.outputs.backend-image-tag }} ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.backend-image-tag }}
        docker tag ${{ needs.build.outputs.frontend-image-tag }} ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.frontend-image-tag }}
        
        docker push ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.backend-image-tag }}
        docker push ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.frontend-image-tag }}
    
    - name: Deploy to Container Apps
      run: |
        # Deploy backend (environment variables are pre-configured in Container App)
        az containerapp update \
          --name ${{ vars.BACKEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.backend-image-tag }}
        
        # Deploy frontend (environment variables are pre-configured in Container App)
        az containerapp update \
          --name ${{ vars.FRONTEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.frontend-image-tag }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ vars.AZURE_CLIENT_ID }}
        tenant-id: ${{ vars.AZURE_TENANT_ID }}
        subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
    
    - name: Download backend image
      uses: actions/download-artifact@v4
      with:
        name: backend-image
        path: /tmp
    
    - name: Download frontend image
      uses: actions/download-artifact@v4
      with:
        name: frontend-image
        path: /tmp
    
    - name: Load and push images to ACR
      run: |
        # Load Docker images
        docker load --input /tmp/backend.tar
        docker load --input /tmp/frontend.tar
        
        # Login to ACR
        az acr login --name ${{ vars.ACR_NAME }}
        
        # Tag and push images
        docker tag ${{ needs.build.outputs.backend-image-tag }} ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.backend-image-tag }}
        docker tag ${{ needs.build.outputs.frontend-image-tag }} ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.frontend-image-tag }}
        
        docker push ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.backend-image-tag }}
        docker push ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.frontend-image-tag }}
    
    - name: Deploy to Container Apps
      run: |
        # Deploy backend (environment variables are pre-configured in Container App)
        az containerapp update \
          --name ${{ vars.BACKEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.backend-image-tag }}
        
        # Deploy frontend (environment variables are pre-configured in Container App)
        az containerapp update \
          --name ${{ vars.FRONTEND_APP_NAME }} \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --image ${{ vars.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.frontend-image-tag }}